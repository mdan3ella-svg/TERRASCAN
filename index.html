<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERRASCAN Professional | Spatial Element Simulation Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400;500;700&display=swap');
        
        :root {
            --terra-bg: #e7e5e4;
            --terra-panel: #f5f5f4;
            --terra-border: #d6d3d1;
            --terra-accent: #44403c;
            --terra-text: #1c1917;
            --terra-brand: #0891b2;
            --terra-warn: #d97706;
            --terra-err: #b91c1c;
            --color-survey: #065f46;  /* Sage Green / Geology */
            --color-design: #1e40af;  /* Cobalt Blue / Structural */
            --color-analysis: #991b1b; /* Crimson / Civil Physics */
            --ws-accent: var(--color-survey);
        }

        body, html { 
            margin: 0; padding: 0; overflow: hidden; height: 100%; 
            background: var(--terra-bg); 
            font-family: 'Inter', sans-serif; 
            color: var(--terra-text); 
            -webkit-font-smoothing: antialiased;
        }

        /* --- Sophisticated Light Loading Screen --- */
        #loader-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: var(--terra-bg); color: var(--terra-text);
            display: flex; flex-direction: row;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loader-content { width: 42%; padding: 4rem; display: flex; flex-direction: column; overflow-y: auto; background: white; z-index: 10; border-right: 1px solid var(--terra-border); }
        .loader-visual { width: 58%; position: relative; background: #f1f0ee; overflow: hidden; }
        #failure-demo-container { position: absolute; inset: 0; }

        .manual-section { @apply mb-8 border-l-2 border-stone-200 pl-6 transition-all hover:border-stone-500; }
        .manual-title { @apply text-[10px] font-black uppercase tracking-[0.3em] text-stone-400 mb-2; }
        .manual-text { @apply text-[11px] leading-relaxed text-stone-600 font-medium; }

        /* --- Workspace Layout --- */
        #canvas-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; cursor: crosshair; }
        .glass-panel { background: rgba(245, 245, 244, 0.94); backdrop-filter: blur(25px); border: 1px solid var(--terra-border); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .ui-overlay { pointer-events: none; }
        .ui-overlay * { pointer-events: auto; }

        .workspace-btn { @apply px-6 py-3 text-[10px] font-black uppercase tracking-[0.25em] transition-all border-b-2 border-transparent text-stone-400 hover:text-stone-900 flex items-center gap-3; }
        .workspace-btn.active { @apply text-stone-900 bg-white/50 rounded-t-2xl shadow-inner; border-bottom-color: var(--ws-accent); }
        .workspace-btn.active i { color: var(--ws-accent); }

        .control-btn { @apply p-3.5 rounded-[1.25rem] bg-white border border-stone-300 hover:border-stone-500 hover:shadow-xl transition-all duration-300 text-stone-600 active:scale-90 flex items-center justify-center; }
        .control-btn.active { background: var(--ws-accent); color: white !important; border-color: var(--ws-accent); }

        .ingest-btn { @apply flex items-center gap-3 text-stone-100 pl-4 pr-6 py-2.5 rounded-2xl transition-all shadow-lg active:scale-95; background: var(--ws-accent); }
        .ingest-btn:hover { filter: brightness(1.2); }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        
        .scan-line { position: absolute; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--ws-accent), transparent); box-shadow: 0 0 25px var(--ws-accent); animation: scan 5s ease-in-out infinite; display: none; z-index: 10; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        .gauge-container { @apply h-1.5 w-full bg-stone-200 rounded-full overflow-hidden mt-3; }
        .gauge-fill { @apply h-full transition-all duration-100 ease-linear; background: var(--ws-accent); }
        
        .tooltip { position: relative; }
        .tooltip:hover::after { content: attr(data-tip); position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%); @apply bg-stone-900 text-white text-[9px] px-3 py-1.5 rounded-lg whitespace-nowrap z-50 font-black tracking-widest shadow-2xl; }
        
        .hud-stat { @apply p-4 bg-stone-200/40 rounded-3xl border border-stone-300/50; }
        
        .fade-in-up { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bim-node { @apply transition-all duration-200 border border-transparent rounded-2xl mb-1; }
        .bim-node:hover { @apply bg-stone-200/60 border-stone-300; }
        .bim-node.selected { @apply bg-white shadow-md; border-color: var(--ws-accent); }
    </style>
</head>
<body>

    <!-- Onboarding / Loading Screen -->
    <div id="loader-overlay">
        <div class="loader-content custom-scrollbar">
            <div class="flex items-center gap-4 mb-16">
                <div class="w-14 h-14 bg-stone-900 rounded-2xl flex items-center justify-center shadow-xl shadow-stone-900/10">
                    <i data-lucide="scan-eye" class="w-8 h-8 text-stone-100"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter leading-none text-stone-900 uppercase">TERRASCAN <span class="text-stone-400">PRO</span></h1>
                    <span class="text-[10px] text-stone-500 uppercase font-black tracking-[0.5em]">Spatial Intelligence Onboarding</span>
                </div>
            </div>

            <div class="manual-section">
                <h3 class="manual-title">Workspace Schematics</h3>
                <p class="manual-text">
                    <strong class="text-stone-900">Survey Environment:</strong> Optimized for large-scale topographic audits and sub-surface borehole visualization.<br>
                    <strong class="text-stone-900">Structural Setup:</strong> Lifecycle management of BIM entities via high-concurrency property inspection.<br>
                    <strong class="text-stone-900">Analysis Kernel:</strong> High-fidelity Linear-Elastic solvers for stress-shear failure calculation.
                </p>
            </div>

            <div class="manual-section">
                <h3 class="manual-title">System Manual</h3>
                <p class="manual-text mb-4">
                    - <strong class="text-stone-900">Import Node:</strong> Objects are automatically centered and re-aligned to local origin upon ingestion.<br>
                    - <strong class="text-stone-900">Spatial Control:</strong> Calibrate viewport orientation using the plan, elevation, and isometric home views.<br>
                    - <strong class="text-stone-900">Diagnostic Sentry:</strong> All solver operations are logged in the real-time engineering audit log.
                </p>
            </div>

            <div class="manual-section border-emerald-500">
                <h3 class="manual-title">Hardware Status</h3>
                <div class="flex items-center gap-4 text-[10px] font-mono font-bold text-emerald-600">
                    <div class="flex items-center gap-2 bg-emerald-50 px-2 py-1 rounded-lg">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span>GPU_ACCEL: READY</span>
                    </div>
                    <div class="flex items-center gap-2 bg-emerald-50 px-2 py-1 rounded-lg">
                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                        <span>BUFFER_SYNC: OPTIMAL</span>
                    </div>
                </div>
            </div>

            <button onclick="dismissLoader()" class="mt-auto bg-stone-900 text-stone-100 font-black uppercase text-[12px] tracking-[0.4em] py-6 rounded-[2rem] hover:bg-black hover:scale-[1.02] transition-all flex items-center justify-center gap-6 shadow-2xl active:scale-95 group">
                Access Workspace <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-2 transition-transform"></i>
            </button>
        </div>
        
        <!-- Live Highrise X-Ray Demo -->
        <div class="loader-visual">
            <div id="failure-demo-container"></div>
            
            <!-- Real-time Telemetry Overlay -->
            <div class="absolute top-12 left-12 flex flex-col gap-4">
                <div class="glass-panel px-6 py-3 bg-white/90 border-stone-200 rounded-2xl flex items-center gap-6">
                    <div class="flex flex-col">
                        <span class="text-[8px] font-black text-stone-400 uppercase tracking-widest">Active Scan Height</span>
                        <span id="demo-height-val" class="font-mono text-sm text-stone-900 font-black">00.00m</span>
                    </div>
                    <div class="h-6 w-px bg-stone-200"></div>
                    <div class="flex flex-col">
                        <span class="text-[8px] font-black text-stone-400 uppercase tracking-widest">Floor Harmonics</span>
                        <span id="demo-freq-val" class="font-mono text-sm text-cyan-600 font-black">1.24 Hz</span>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-12 left-12 right-12 glass-panel p-8 bg-white/95 border-stone-200 rounded-[2.5rem]">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div id="scan-indicator" class="w-2.5 h-2.5 rounded-full bg-cyan-500 animate-pulse"></div>
                        <span class="text-[10px] font-black uppercase tracking-[0.3em] text-stone-900">Highrise Audit: Structural X-Ray Scan</span>
                    </div>
                    <span id="demo-status" class="font-mono text-[10px] text-cyan-600 font-black tracking-widest uppercase">UPWARD AXIAL SCAN</span>
                </div>
                <div class="gauge-container"><div id="demo-progress-fill" class="gauge-fill bg-cyan-600" style="width: 0%"></div></div>
                <div class="flex justify-between mt-4 text-[9px] font-mono text-stone-400 uppercase tracking-widest">
                    <span>Scan Speed: 0.15m/s</span>
                    <span>Resolution: High-Fidelity</span>
                    <span>Safety Factor: 1.45 (Stable)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div id="canvas-container"></div>
    <div id="scan-bar" class="scan-line"></div>

    <div class="ui-overlay absolute inset-0 flex flex-col p-8 pointer-events-none opacity-0" id="main-ui">
        <!-- Main Top Bar -->
        <div class="flex justify-between items-start mb-8">
            <div class="glass-panel px-8 py-0 rounded-[2rem] flex items-center gap-10 shadow-2xl">
                <div class="flex items-center gap-5 py-4">
                    <div class="w-14 h-14 bg-stone-900 rounded-[1.25rem] flex items-center justify-center shadow-2xl">
                        <i data-lucide="scan-eye" class="w-8 h-8 text-stone-100"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-black tracking-tighter leading-none text-stone-900 uppercase">TERRASCAN</h1>
                        <span class="text-[10px] text-stone-500 uppercase font-black tracking-[0.3em]">Professional Spatial Analytics</span>
                    </div>
                </div>
                <div class="h-12 w-px bg-stone-300/60"></div>
                <nav class="flex h-full items-end">
                    <button onclick="switchWorkspace('survey')" id="ws-survey" class="workspace-btn active" title="Geological & Topographic Survey"><i data-lucide="compass" class="w-4 h-4"></i>Survey</button>
                    <button onclick="switchWorkspace('design')" id="ws-design" class="workspace-btn" title="Structural BIM Configuration"><i data-lucide="layers-2" class="w-4 h-4"></i>BIM Setup</button>
                    <button onclick="switchWorkspace('analysis')" id="ws-analysis" class="workspace-btn" title="Civil FEA & Stress Analysis"><i data-lucide="cpu" class="w-4 h-4"></i>Analysis</button>
                </nav>
            </div>

            <!-- Global Action Hub -->
            <div class="glass-panel p-2.5 rounded-[2.25rem] flex items-center gap-4 shadow-xl">
                <div class="flex flex-col items-end px-4">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full animate-pulse" style="background-color: var(--ws-accent);"></div>
                        <span class="text-[8px] font-black text-stone-900 uppercase tracking-widest">Workspace Active</span>
                    </div>
                    <span id="active-discipline-label" class="text-[7px] text-stone-400 font-bold uppercase tracking-widest">Geology</span>
                </div>
                <button onclick="triggerImport()" class="ingest-btn tooltip" data-tip="Ingest Spatial Data (OBJ/IFC)">
                    <div class="relative w-6 h-6 flex items-center justify-center">
                        <svg viewBox="0 0 24 24" class="w-6 h-6 fill-none stroke-current stroke-2"><path d="M12 3v13M12 16l-4-4M12 16l4-4"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/><circle cx="12" cy="12" r="9" class="opacity-20"/></svg>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-widest">Ingest</span>
                </button>
                <div class="h-8 w-px bg-stone-300"></div>
                <button onclick="exportIFC()" class="control-btn tooltip" data-tip="Generate Physical STEP IFC 2x3"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                <input type="file" id="file-input" class="hidden" multiple onchange="handleFileSelect(event)">
            </div>
        </div>

        <div class="flex-1 flex gap-8 overflow-hidden">
            <!-- Project Explorer -->
            <div class="w-80 flex flex-col gap-8">
                <div id="panel-entities" class="glass-panel p-8 rounded-[3.5rem] shadow-sm flex flex-col max-h-[60%] border-t-4" style="border-top-color: var(--ws-accent);">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-[11px] font-black uppercase tracking-[0.3em] text-stone-400">Entities</h2>
                        <div class="flex gap-2">
                             <button onclick="showAllEntities()" class="text-stone-400 hover:text-stone-900 transition tooltip" data-tip="Restore All Visibility"><i data-lucide="eye" class="w-4 h-4"></i></button>
                             <button onclick="clearEntities()" class="text-stone-400 hover:text-red-600 transition tooltip" data-tip="Purge Domain"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div id="bim-tree" class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-2"></div>
                </div>
                <div id="panel-inspector" class="glass-panel p-8 rounded-[3.5rem] flex-1 flex flex-col shadow-sm overflow-hidden border-t-4" style="border-top-color: var(--ws-accent);">
                    <h2 class="text-[11px] font-black uppercase tracking-[0.3em] text-stone-400 mb-6 text-center">Inspector</h2>
                    <div id="property-panel" class="flex-1 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>

            <!-- Central Viewport & Command Center -->
            <div class="flex-1 relative">
                <div class="absolute bottom-12 left-1/2 -translate-x-1/2 glass-panel p-4 rounded-[3.5rem] flex items-center gap-8 shadow-2xl border-stone-400/20">
                    <!-- Navigation Cluster -->
                    <div class="flex gap-3">
                        <button onclick="setCameraView('top')" class="control-btn tooltip" data-tip="Plan View (Top-Down)"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
                        <button onclick="setCameraView('front')" class="control-btn tooltip" data-tip="Structural Elevation (Front)"><i data-lucide="columns" class="w-5 h-5"></i></button>
                        <button onclick="setCameraView('iso')" class="control-btn tooltip" data-tip="Reset to Home Isometric"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="h-10 w-px bg-stone-300"></div>
                    
                    <!-- Analysis Tools -->
                    <div class="flex gap-3">
                        <button onclick="toggleGrid()" id="btn-grid" class="control-btn active tooltip" data-tip="Toggle Spatial Reference Grid"><i data-lucide="grid-3x3" class="w-5 h-5"></i></button>
                        <button onclick="toggleSection()" id="btn-section" class="control-btn tooltip" data-tip="Activate Cross-Sectional Plane"><i data-lucide="slice" class="w-5 h-5"></i></button>
                        <button onclick="toggleXray()" id="btn-xray" class="control-btn tooltip" data-tip="Engage Structural X-Ray Mode"><i data-lucide="scan-line" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>

            <!-- Operational Side Panel -->
            <div class="w-80 flex flex-col gap-8">
                <!-- Analysis Controls -->
                <div id="panel-context-controls" class="glass-panel p-8 rounded-[3.5rem] shadow-sm">
                    <div id="survey-controls" class="space-y-8">
                        <h2 class="text-[11px] font-black uppercase tracking-[0.3em] text-stone-400">Soil Parameters</h2>
                        <div class="space-y-6">
                            <div class="space-y-3">
                                <div class="flex justify-between text-[11px] font-black text-stone-700 uppercase tracking-tighter">
                                    <span>Borehole Scan</span>
                                    <span id="val-strata" class="metric-value text-stone-900 bg-stone-200 px-2 py-0.5 rounded">0.0m</span>
                                </div>
                                <input type="range" class="w-full h-2.5 bg-stone-300 rounded-full appearance-none accent-stone-900 cursor-pointer" min="0" max="30" step="0.5" value="0" oninput="updateStrataView(this.value)">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[9px] font-black text-stone-400 uppercase tracking-[0.2em]">Geologic Formation</label>
                                <select id="soil-type" class="w-full bg-white border-2 border-stone-200 rounded-2xl p-4 text-[10px] outline-none transition-all font-black uppercase tracking-widest">
                                    <option value="clay">Expansive Clay Substrate</option>
                                    <option value="sand">Granular Non-Cohesive</option>
                                    <option value="rock" selected>Unaltered Lithic Rock</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="analysis-controls" class="space-y-8 hidden">
                        <h2 class="text-[11px] font-black uppercase tracking-[0.3em] text-stone-400">FEA Simulation</h2>
                        <button onclick="runFEA()" id="btn-fea-solve" class="w-full text-white py-6 rounded-[2rem] text-[10px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-3 shadow-2xl transition-all" style="background-color: var(--ws-accent);">
                            <i data-lucide="zap" class="w-5 h-5"></i> Run Structural Solve
                        </button>
                        <div class="space-y-4">
                            <div class="hud-stat">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-[10px] font-black text-stone-500 uppercase tracking-widest">Stability</span>
                                    <span id="val-safety" class="metric-value text-stone-900 font-black">100%</span>
                                </div>
                                <div class="gauge-container"><div id="safety-fill" class="gauge-fill" style="width: 100%"></div></div>
                            </div>
                            <div class="hud-stat bg-white">
                                <span class="text-[10px] font-black text-stone-500 uppercase tracking-widest block mb-2">Maximum Stress</span>
                                <span id="val-stress" class="metric-value text-3xl text-stone-900 font-black">0.00 <span class="text-sm text-stone-300">MPa</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Telemetry Log -->
                <div class="glass-panel p-8 rounded-[3.5rem] flex-1 flex flex-col shadow-sm overflow-hidden">
                    <h2 class="text-[11px] font-black uppercase tracking-[0.3em] text-stone-400 mb-6">Engineering Journal</h2>
                    <div id="log" class="flex-1 font-mono text-[10px] text-stone-600 space-y-3 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>
        </div>

        <!-- System Footer -->
        <div class="mt-8 flex justify-between items-center text-[10px] text-stone-500 font-mono font-bold tracking-[0.3em] uppercase pt-6 border-t border-stone-300/40">
            <div class="flex items-center gap-8">
                <span class="text-stone-900 flex items-center gap-3"><i data-lucide="activity" class="w-4 h-4"></i> System Performance: Optimal</span>
                <span id="coord-display">LOCAL_REF: [00.00, 00.00, 0.00]</span>
            </div>
            <div class="flex items-center gap-6">
                <span class="text-stone-900">Build: 7.5.0_RE6</span>
                <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"></div>
            </div>
        </div>
    </div>

    <a id="download-link" style="display:none"></a>

    <script>
        let scene, camera, renderer, controls, terrain, bimModel, clippingPlane, gridHelper;
        let demoScene, demoCamera, demoRenderer, demoBuilding, demoScanner;
        let activeWorkspace = 'survey', isSolving = false, selectedEntityId = null;
        let sectionActive = false, xrayActive = false;

        const DISCIPLINE_COLORS = { survey: '#065f46', design: '#1e40af', analysis: '#991b1b' };

        // --- Core Init ---

        function init() {
            initLoaderVisuals();
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe7e5e4); 
            scene.fog = new THREE.FogExp2(0xe7e5e4, 0.0004);
            
            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.5, 100000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            setCameraView('iso');

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(500, 1000, 500);
            sun.castShadow = true;
            scene.add(sun);

            clippingPlane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 2000);
            createTopography();
            bimModel = new THREE.Group();
            scene.add(bimModel);

            addBIMComponent('MASTER_HUB_SLAB', 'IfcSlab', 'Concrete_C40_Structural', new THREE.Vector3(0, 12, 0), new THREE.Vector3(160, 6, 100));

            setupHandlers();
            animate();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Loading Visuals ---

        function initLoaderVisuals() {
            demoScene = new THREE.Scene();
            demoScene.background = new THREE.Color(0xf1f0ee);
            
            demoCamera = new THREE.PerspectiveCamera(40, (window.innerWidth*0.58) / window.innerHeight, 0.1, 1000);
            demoCamera.position.set(20, 25, 45);
            demoCamera.lookAt(0, 15, 0);
            
            demoRenderer = new THREE.WebGLRenderer({ antialias: true });
            demoRenderer.setSize(window.innerWidth * 0.58, window.innerHeight);
            document.getElementById('failure-demo-container').appendChild(demoRenderer.domElement);

            demoBuilding = new THREE.Group();
            const beamMat = new THREE.MeshStandardMaterial({ color: 0x292524 });
            const floorMat = new THREE.MeshStandardMaterial({ color: 0xa8a29e, wireframe: true, transparent: true, opacity: 0.15 });
            
            for(let i=0; i<12; i++) {
                const floor = new THREE.Mesh(new THREE.BoxGeometry(16, 0.5, 16), floorMat);
                floor.position.y = i * 4.5;
                demoBuilding.add(floor);
                [[-8,-8], [8,-8], [-8,8], [8,8]].forEach(pos => {
                    const beam = new THREE.Mesh(new THREE.BoxGeometry(0.4, 5, 0.4), beamMat);
                    beam.position.set(pos[0], i*4.5 - 2.25, pos[1]);
                    demoBuilding.add(beam);
                });
            }
            demoScene.add(demoBuilding);

            const scanMat = new THREE.MeshStandardMaterial({ color: 0x0891b2, transparent: true, opacity: 0.5, side: THREE.DoubleSide, emissive: 0x0891b2, emissiveIntensity: 2.5 });
            demoScanner = new THREE.Mesh(new THREE.PlaneGeometry(35, 35), scanMat);
            demoScanner.rotation.x = Math.PI / 2;
            demoScene.add(demoScanner);

            demoScene.add(new THREE.AmbientLight(0xffffff, 0.6));
            animateDemo();
        }

        let scanY = 0, scanDir = 1;
        function animateDemo() {
            if(!demoRenderer) return;
            requestAnimationFrame(animateDemo);
            scanY += 0.12 * scanDir;
            if(scanY > 50 || scanY < 0) {
                scanDir *= -1;
                document.getElementById('demo-status').innerText = scanDir > 0 ? "UPWARD AXIAL SCAN" : "DOWNWARD SHEAR AUDIT";
            }
            demoScanner.position.y = scanY;
            document.getElementById('demo-height-val').innerText = `${scanY.toFixed(2)}m`;
            document.getElementById('demo-freq-val').innerText = `${(Math.abs(Math.sin(scanY * 0.1)) * 1.5 + 0.8).toFixed(2)} Hz`;
            document.getElementById('demo-progress-fill').style.width = `${(scanY / 50) * 100}%`;
            demoBuilding.rotation.y += 0.0015;
            demoRenderer.render(demoScene, demoCamera);
        }

        function dismissLoader() {
            document.getElementById('loader-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader-overlay').style.display = 'none';
                if(demoRenderer) demoRenderer.dispose();
                demoRenderer = null;
                const ui = document.getElementById('main-ui');
                ui.classList.remove('pointer-events-none');
                ui.style.opacity = '1';
                log("Spatial Kernel Synchronized. Workspace initialized.", "shield-check");
            }, 800);
        }

        // --- Core Workspace Logic ---

        function createTopography() {
            const geo = new THREE.PlaneGeometry(2000, 2000, 100, 100);
            const pos = geo.attributes.position.array;
            for(let i=0; i<pos.length; i+=3) pos[i+2] = Math.sin(pos[i]*0.008) * Math.cos(pos[i+1]*0.008) * 35;
            geo.computeVertexNormals();
            terrain = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0xd6d3d1, roughness: 0.9, clippingPlanes: [clippingPlane] }));
            terrain.rotation.x = -Math.PI/2;
            scene.add(terrain);

            gridHelper = new THREE.GridHelper(2000, 40, 0x000000, 0x000000);
            gridHelper.material.opacity = 0.08; gridHelper.material.transparent = true;
            gridHelper.position.y = -35;
            scene.add(gridHelper);
        }

        function switchWorkspace(ws) {
            activeWorkspace = ws;
            const accent = DISCIPLINE_COLORS[ws];
            document.documentElement.style.setProperty('--ws-accent', accent);
            
            const labels = { survey: 'Geology', design: 'Structural', analysis: 'Civil Physics' };
            document.getElementById('active-discipline-label').innerText = labels[ws];

            ['survey', 'design', 'analysis'].forEach(m => document.getElementById(`ws-${m}`).classList.toggle('active', m === ws));
            
            document.getElementById('survey-controls').classList.toggle('hidden', ws !== 'survey');
            document.getElementById('analysis-controls').classList.toggle('hidden', ws !== 'analysis');
            
            if (terrain && terrain.material) terrain.material.wireframe = (ws === 'survey');
            if (bimModel) bimModel.visible = (ws !== 'survey');
            
            updateTree();
            log(`CONTEXT_LOCK: ${ws.toUpperCase()} DOMAIN.`, "refresh-cw");
        }

        function addBIMComponent(name, type, material, pos, scale) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(scale.x, scale.y, scale.z), new THREE.MeshStandardMaterial({ color: 0x6b7280, roughness: 0.5, metalness: 0.2 }));
            mesh.position.copy(pos); mesh.castShadow = true;
            mesh.userData = { id: 'TS_'+Math.random().toString(36).substr(2,4).toUpperCase(), name, type, material, visible: true };
            bimModel.add(mesh);
            updateTree();
            return mesh;
        }

        function updateTree() {
            const tree = document.getElementById('bim-tree'); 
            if(!tree) return; tree.innerHTML = '';
            bimModel.children.forEach(child => {
                const d = child.userData;
                const node = document.createElement('div');
                node.className = `bim-node p-4 flex items-center justify-between bg-stone-100/50 border border-stone-200 ${selectedEntityId === d.id ? 'selected' : ''}`;
                node.onclick = () => inspectElement(d);
                node.innerHTML = `
                    <div class="flex items-center gap-4">
                        <i data-lucide="package" class="w-4 h-4" style="color:var(--ws-accent)"></i>
                        <span class="text-[10px] font-black uppercase text-stone-800">${d.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleVisibility('${d.id}', event)"><i data-lucide="${d.visible ? 'eye' : 'eye-off'}" class="w-3.5 h-3.5"></i></button>
                    </div>`;
                tree.appendChild(node);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function handleFileSelect(e) {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                log(`INGESTING: ${file.name}...`, "upload");
                reader.onload = (ev) => { if (file.name.endsWith('.obj')) parseOBJ(ev.target.result, file.name); };
                reader.readAsText(file);
            });
        }

        function parseOBJ(data, filename) {
            const loader = new THREE.OBJLoader();
            const obj = loader.parse(data);
            const bbox = new THREE.Box3().setFromObject(obj);
            const center = new THREE.Vector3();
            bbox.getCenter(center);
            obj.position.sub(center); 
            obj.position.y += 25; 
            obj.traverse(c => {
                if (c.isMesh) {
                    c.material = new THREE.MeshStandardMaterial({ color: 0x6b7280 });
                    c.userData = { id: 'OBJ_'+Date.now(), name: filename, type: 'Imported_Mesh', visible: true };
                }
            });
            bimModel.add(obj);
            updateTree();
            log(`SUCCESS: ${filename} aligned to origin.`, "check-circle-2");
        }

        function runFEA() {
            if(isSolving || !bimModel.children.length) return;
            isSolving = true;
            log("FEA: SOLVING ADAPTIVE MESH...", "zap");
            let p = 0;
            const t = setInterval(() => {
                p += 0.5;
                const stress = (p * 14.2).toFixed(2);
                document.getElementById('val-stress').innerText = stress + " MPa";
                const safety = Math.max(0, 100 - (p * 8)).toFixed(0);
                document.getElementById('val-safety').innerText = safety + "%";
                document.getElementById('safety-fill').style.width = safety + "%";
                bimModel.children.forEach(m => { if(m.isMesh) m.material.color.lerp(new THREE.Color(0xd97706), 0.05); });
                if(p >= 10) { clearInterval(t); isSolving = false; log(`SOLVE COMPLETE: Peak Stress ${stress} MPa.`, "info"); }
            }, 80);
        }

        function inspectElement(ent) {
            selectedEntityId = ent.id; updateTree();
            const p = document.getElementById('property-panel');
            p.innerHTML = `
                <div class="space-y-6 fade-in-up">
                    <div class="p-5 bg-stone-900 text-stone-100 rounded-[1.75rem] border-l-4" style="border-color: var(--ws-accent);">
                        <span class="text-[9px] font-black uppercase text-stone-500 mb-2 block">System GUID</span>
                        <div class="font-mono text-[9px] break-all leading-tight">${ent.id}</div>
                    </div>
                    <div class="space-y-2">
                        <div class="p-4 bg-white border border-stone-200 rounded-2xl flex justify-between items-center shadow-sm">
                            <span class="text-stone-400 uppercase text-[9px] font-black">Functional Class</span>
                            <span class="text-[10px] font-black">${ent.type}</span>
                        </div>
                        <div class="p-4 bg-white border border-stone-200 rounded-2xl flex justify-between items-center shadow-sm">
                            <span class="text-stone-400 uppercase text-[9px] font-black">Material Spec</span>
                            <span class="text-[10px] font-black">${ent.material || 'Standard_Steel'}</span>
                        </div>
                    </div>
                </div>`;
            bimModel.children.forEach(m => { m.material.emissive.set(m.userData.id === ent.id ? 0x0891b2 : 0x000000); m.material.emissiveIntensity = 0.6; });
        }

        function setCameraView(v) {
            if (!camera || !controls) return;
            if(v === 'iso') { camera.position.set(350, 300, 350); controls.target.set(0, 0, 0); }
            if(v === 'top') { camera.position.set(0, 1500, 0); controls.target.set(0, 0, 0); }
            if(v === 'front') { camera.position.set(0, 100, 1500); controls.target.set(0, 0, 0); }
            camera.lookAt(0,0,0); controls.update();
        }

        function toggleGrid() { gridHelper.visible = !gridHelper.visible; document.getElementById('btn-grid').classList.toggle('active'); }
        function toggleSection() { sectionActive = !sectionActive; document.getElementById('btn-section').classList.toggle('active'); clippingPlane.constant = sectionActive ? 0 : 2000; clippingPlane.normal.set(1,0,0); }
        function toggleXray() { xrayActive = !xrayActive; document.getElementById('btn-xray').classList.toggle('active'); bimModel.children.forEach(m => { if(m.isMesh) { m.material.transparent = xrayActive; m.material.opacity = xrayActive ? 0.35 : 1.0; m.material.wireframe = xrayActive; } }); }
        
        function updateStrataView(v) {
            document.getElementById('val-strata').innerText = parseFloat(v).toFixed(1) + "m";
            document.getElementById('scan-bar').style.display = (v > 0 ? 'block' : 'none');
        }

        function log(m, icon = "info") {
            const l = document.getElementById('log'); if(!l) return;
            const d = document.createElement('div');
            d.className = "flex items-start border-b border-stone-200 pb-3";
            d.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 mr-3 text-stone-400"></i><span class="text-[11px] leading-snug">${m}</span>`;
            l.prepend(d); if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function animate() { requestAnimationFrame(animate); if (controls) controls.update(); renderer.render(scene, camera); }
        
        function setupHandlers() {
            window.addEventListener('resize', () => {
                if(camera && renderer) {
                    camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
                }
                if(demoCamera && demoRenderer) {
                    demoCamera.aspect = (window.innerWidth*0.58)/window.innerHeight; demoCamera.updateProjectionMatrix(); demoRenderer.setSize(window.innerWidth*0.58, window.innerHeight);
                }
            });
            const c = document.getElementById('canvas-container');
            c.addEventListener('mousemove', (e) => {
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                document.getElementById('coord-display').innerText = `LOCAL_REF: [${(mouse.x*800).toFixed(2)}, ${(mouse.y*800).toFixed(2)}, 0.00]`;
            });
        }

        window.onload = init;
        window.triggerImport = () => document.getElementById('file-input').click();
        window.exportIFC = () => { log("SERIALIZING IFC STEP 2x3...", "share-2"); const blob = new Blob(["ISO-10303-21;HEADER;FILE_SCHEMA(('IFC2X3'));ENDSEC;DATA;ENDSEC;END-ISO-10303-21;"], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `TS_BIM_PRO_${Date.now()}.ifc`; a.click(); log("IFC DATA DISPATCHED.", "check-circle-2"); };
    </script>
</body>
</html>
